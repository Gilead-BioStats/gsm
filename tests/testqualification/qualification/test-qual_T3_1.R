## Test Setup
ae_workflow <- flatten(MakeWorkflowList("kri0001"))

steps <- c(1, 3:length(ae_workflow$steps))

outputs <- map_vec(ae_workflow$steps[steps], ~ .x$output)

## Test Code
testthat::test_that("Given pre-processed input data, a properly specified Workflow for a KRI creates summarized and flagged data", {
  test <- robust_runworkflow(
    ae_workflow,
    list(
      Analysis_Input = gsm::analyticsInput,
      Mapped_AE = mapped_data[["Mapped_AE"]],
      Mapped_SUBJ = mapped_data[["Mapped_SUBJ"]]
    ),
    step = steps
  )
  expect_true(all(outputs %in% names(test)))
  expect_true(is.vector(test$vThreshold))
  expect_true(all(map_lgl(test[outputs[!(outputs %in% c("vThreshold", "lAnalysis"))]], is.data.frame)))
  expect_equal(nrow(test$Analysis_Flagged), nrow(test$Analysis_Summary))
  expect_identical(sort(test$Analysis_Flagged$GroupID), sort(test$Analysis_Summary$GroupID))
})
