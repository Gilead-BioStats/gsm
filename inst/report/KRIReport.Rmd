---
subtitle: "Generated with the Gilead Statistical Monitoring {gsm} package"
output:
  html_document:
    toc: true
    toc_float:
       collapsed: false
       smooth_scroll: true
    css: styles.css
params:
    assessment: NA
    status_study: NA
---

```{r, echo=FALSE}
AddGileadLogo()
```

---

```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
library(gsm)
library(tidyverse)
library(DT)

# Study_Assess() output - KRIs only
assessment <- params$assessment[
  grep("kri", names(params$assessment))
]

# Overview Table - data.frame/raw data
overview_raw_table <- Overview_Table(assessment, bInteractive = FALSE)

# Pull the number of KRIs (red or amber) and sum
# -- displays red/yellow boxes at top of report
red_kris <- overview_raw_table %>% pull(`Red KRIs`) %>% sum()
amber_kris <- overview_raw_table %>% pull(`Amber KRIs`) %>% sum()


## StudyID
study_id <- ExtractStudyId(assessment)
```

---
title: "`r study_id` Assessment Overview"
---

<div class = 'overall-site-select'
    id = 'overall-site-select'
    title = 'Selected site will be highlighted in all charts for all KRIs.'>
</div>


```{r, echo=FALSE, results='asis'}


## metadata report if longitudinal data is provided
if (exists('status_study', where = params) && !is.null(params$status_study)) {
  
MakeStudyStatusTable(params$status_study)
  
 glue::glue(
'
---
date: "Snapshot Date: {params$status_study$gsm_analysis_date}"
---
')
 
}
```


## Study Overview

<div class="flag-container">
  <div class="flag flag-red">`r red_kris` Red KRIs</div>
  <div class="flag flag-amber">`r amber_kris` Amber KRIs</div>
</div>


<div class="gsm-overview-table">
```{r echo=FALSE, warning=FALSE}
Overview_Table(assessment)
```
</div>

## Results
```{r, echo=FALSE}
summary_table <- MakeSummaryTable(assessment)
```


```{r, echo=FALSE, results='asis'}
for (i in seq_along(assessment)) {
  kri_key <- names(assessment)[i]
  kri <- assessment[[ kri_key ]]

  title <- gsm::meta_workflow %>% 
    filter(workflowid == kri_key) %>% 
    pull(metric)

  ### KRI section /
    print(htmltools::h3(title))

    #### charts tabset /
        cat("#### Summary Charts {.tabset} \n")
        
        charts <- assessment[[i]]$lResults$lCharts[
            names(assessment[[i]]$lResults$lCharts) %in% c("scatterJS", "barMetricJS", "barScoreJS", "timeSeriesContinuousJS")
        ]
        
        for (j in seq_along(charts)) {
            chart_key <- names(charts)[j]
            chart <- charts[[ chart_key ]]
            chart_name <- switch(
                chart_key,
                scatterJS = "Scatter Plot",
                barScoreJS = "Bar Chart (KRI Score)",
                barMetricJS = "Bar Chart (KRI Metric)",
                timeSeriesContinuousJS = "Time Series (Continuous)"
            )

            ##### chart tab /
                chart_header <- paste('#####', chart_name, '\n')

                cat(chart_header)
                
                # need to initialize JS dependencies within loop in order to print correctly
                # see here: https://github.com/rstudio/rmarkdown/issues/1877#issuecomment-678996452
                purrr::map(
                charts,
                ~.x %>%
                    knitr::knit_print() %>%
                    attr('knit_meta') %>%
                    knitr::knit_meta_add() %>%
                    invisible()
                )
            
                # Display chart.
                cat(paste0("<div class =", chart_key, ">"))
                cat(knitr::knit_print(htmltools::tagList(chart)))
                cat("</div>")
            ##### / chart tab
        }
        
        cat("#### {-} \n")
    #### / charts tabset

    #### table /
        if (!is.null(summary_table[[assessment[[i]]$name]])) {
            print(htmltools::h4("Summary Table"))
            print(htmltools::tagList(summary_table[[assessment[[i]]$name]]))
        }
    #### / table
  ### / KRI section
}
```



## Error Log

```{r echo = FALSE}
MakeErrorLogTable(assessment)
```


```{js, file='../utils-0.0.1/overallSiteDropdown.js', echo=FALSE}
```

```{js, file='../utils-0.0.1/dragOverallSiteDropdown.js', echo=FALSE}
```

```{js, file='../utils-0.0.1/showMetaTableDetails.js', echo=FALSE}
```
