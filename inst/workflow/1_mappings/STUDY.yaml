meta:
  Type: Mapped
  ID: STUDY
  Description: STUDY Data Mapping
  Priority: 3
spec:
  Raw_STUDY:
    studyid:
      required: true
      type: character
      source_col: protocol_number
    nickname:
      required: true
      type: character
    protocol_title:
      required: true
      type: character
    status:
      required: true
      type: character
    num_plan_site:
      required: true
      type: numeric
    num_plan_subj:
      required: true
      type: numeric
  Mapped_SUBJ:
    studyid:
      required: true
      type: character
    invid:
      required: true
      type: character
    subjid:
      required: true
      type: character
steps:
  - output: Temp_CTMSStudyWide
    name: RunQuery
    params:
      df: Raw_STUDY
      strQuery: "SELECT studyid as GroupID, * FROM df"
  - output: Temp_CTMSStudy
    name: MakeLongMeta
    params:
      data: Temp_CTMSStudyWide
      strGroupLevel: "Study"
  - output: Temp_CTMSplanned
    name: RunQuery
    params:
      df: Raw_STUDY
      strQuery: "SELECT studyid as GroupID, num_plan_site as SiteTarget, num_plan_subj as ParticipantTarget FROM df"
  - output: Temp_StudyCountsWide
    name: RunQuery
    params:
      df: Mapped_SUBJ
      strQuery: "SELECT studyid as GroupID, COUNT(DISTINCT subjid) as ParticipantCount, COUNT(DISTINCT invid) as SiteCount FROM df GROUP BY studyid"
  - output: Temp_CountTargetsWide
    name: left_join
    params:
      x: Temp_CTMSplanned
      "y": Temp_StudyCountsWide
      by: GroupID
  - output: Temp_CountTargetsPercsWide
    name: RunQuery
    params:
      df: Temp_CountTargetsWide
      strQuery:
        "SELECT
          (SiteCount*100 / SiteTarget) as PercentSitesActivated,
          (ParticipantCount*100 / ParticipantTarget) as PercentParticipantsEnrolled,
          CONCAT(
            CAST(SiteCount AS CHAR),
            CAST(' / ' AS CHAR),
            CAST(SiteTarget AS CHAR),
            CAST(' (' AS CHAR),
            CAST((SiteCount*100 / SiteTarget) AS CHAR),
            CAST('%)' AS CHAR)
          ) as SiteActivationLabel,
          CONCAT(
            CAST(ParticipantCount AS CHAR),
            CAST(' / ' AS CHAR),
            CAST(ParticipantTarget AS CHAR),
            CAST(' (' AS CHAR),
            CAST((ParticipantCount*100 / ParticipantTarget) AS CHAR),
            CAST('%)' AS CHAR)
          ) as ParticipantEnrollmentLabel,
        * FROM df"
  - output: Temp_CountTargetsPercs
    name: MakeLongMeta
    params:
      data: Temp_CountTargetsPercsWide
      strGroupLevel: "Study"
  - output: Mapped_STUDY
    name: bind_rows
    params:
      Temp_CTMSStudy: Temp_CTMSStudy
      Temp_CountTargetsPercs: Temp_CountTargetsPercs
