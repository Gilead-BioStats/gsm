---
title: "Report Setup for Gismo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Report Setup for Gismo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(gsm)
```

## Overview

This vignette describes how to create new metrics, reports and shiny app modules that are compatible with `gismo`. 

## Study Configuration

Each study will select a set of metrics, reports and apps to be run as part of the Risk Assessment process. These will be documented in the Central Monitoring Plan and converted to a machine-readable study configuration yaml that looks something like this: 

```
StudyID: ABC-123
Users: Admin, User, Restricted
Reports: 
  Admin:
     - deep_dive_app
     - endpoint_pfs_bicr
  User: 
     - kri_site
     - kri_country
     - endpoints_pfs
  Restricted:
     - unblinded_kri_site
Metrics: # all available to everyone
     - kri0001
     - end0001 
     ...
```

Reports listed in the study config can then be set up via metadata provided as part of the package. 


## Report/App Set-up

Each Report will have standard configuration files: 

1. `{report_name}_mapping.yaml` which specifies mappings that go from `Raw_*` data (typically from `Raw+`) to all required `Mapped_*` data to produce the report. 
2. `{report_name}.yaml` A workflow that specifies the steps required to produce the report. This includes the following sections:
  -  `meta`: (required) Report metadata used for centralized library and fields referenced in `steps` section of workflow.
    - This is not required in the `{report_name}.yaml` if the report is entirely comprised of `metric`s that have their own `yaml` configuration files. 
  - `spec`: (optional) Data requirement for the report, when `metric`s are not specified, or do not fully encompass the data requirements of the report. Typically from `Mapped_*` data, but occasionally from `Analytics_*` and `Reporting_*` data sources.
  - `steps`: (required) Functions to produce the reporting output from `Mapped_*` and/or `Reporting_*` data to final output (`html`, `csv` or `shinyApp`).
   
If the report requires the aggregation of metrics, then each metric will have a `{metric_name}.yaml` in the `metrics` directory that includes:

- `meta`: Report metadata used for centralized library and fields referenced in `steps` section of workflow.
- `spec`: Data requirement for that specific metric, typically from `Mapped_*` data, but occasionally from `Analytics_*` and `Reporting_*` data sources.
- `steps`: Functions to create the metric output to be used in the report.
   
### Types of Data Used in Workflows

Throughout this vignette, we will reference a variety of types of data, that all have fixed prefixes to identify their source and usage. Below, the five types of data are defined.

- `Raw_*`
- `Mapped_*`
- `Analytics_*`
- `Reporting_*`
- `Temp_*`
   
### `meta` section content

Meta header required fields for **all** `yaml`s: 

- `Name`: Name of the reporting output.
- `File`: `yaml` file that contains the workflow.
- `ReportID`: The unique report ID that is referenced in the Study Config `yaml`. 
- `Description`: A description of the reporting output specified in the workflow.
- `ReportType`: The type of reporting output specified in the workflow. Valid values: `Application`, `Report`, `Metric`.
- `Repo`: Package repo and version
- `Status`: The validation status of the reporting output. Valid values: 
    - `Qualified`: Output has been qualified via our qualification process specified [here](https://gilead-biostats.github.io/gsm/articles/QualificationWorkflow.html). 
    - `Pilot`: Output is being used by pilot studies and is maintained in a package repository.
    - `Prototype`: Output is created using custom scripts on an ad-hoc basis.
    

Additional meta header required fields **apps** and **reports**: 
- `Permission`: Level of permissions for viewing that match the `Users` argument in the Study Config file. Common values: `Admin`, `Users`.
- `Outputs`: The output
- `Dependencies`: `{gsm}` ecosystem package dependencies. Specified with two elements, `Functions`, `Data`.
    - `Functions`: Names of any functions from other `{gsm}` packages that are required for this workflow. Specify with {package}::{function}.
    - `Data`: Names of any dataframes created in other `{gsm}` packages that are required for this workflow
- `ExampleURL`: Location of a sample report (typically on the pkgdown site)

Example:


#### Required fields

### `spec` section content

any needed data in the mapping layer should be documented here. each column that is needed will contain the following information:
- `required`:
- `type`:


### `steps` section content

#### Example YAML for KRI Report: 

```
meta:
  File: report_example.yaml
  ReportID: example_report
  Name: An example report
  Description: A report that is an example
  Repo: gsm.example
  ExampleURL: https://gilead-biostats.github.io/gsm.example/example_report.html
spec: 
# any needed data in the mapping layer should be documented here. 
  Mapped_AE:
    subjid:
      required: true
      type: character
  Mapped_ENROLL:
    subjid:
      required: true
      type: character
    invid:
      required: true
      type: character
    timeonstudy:
      required: true
      type: numeric
  Mapped_CTMS_SITE
    discontinued_count:
      required: true
      type: numeric
steps:
# TODO Update this to some examples steps
  - name: RunQuery
    output: Reporting_Results_Country
    params:
      df: Reporting_Results
      strQuery: "SELECT * FROM df WHERE GroupLevel == 'Country'"
  - name: RunQuery
    output: Reporting_Metrics_Country
    params:
      df: Reporting_Metrics
      strQuery: "SELECT * FROM df WHERE GroupLevel == 'Country'"
  - name: MakeCharts
    output: lCharts_Country
    params:
      dfResults: Reporting_Results_Country
      dfGroups: Reporting_Groups
      dfBounds: Reporting_Bounds
      dfMetrics: Reporting_Metrics
  - name: Report_KRI
    output: lReport 
    params:
      lCharts: lCharts_Country
      dfResults: Reporting_Results_Country
      dfGroups: Reporting_Groups
      dfMetrics: Reporting_Metrics_Country
```

## Step-by-Step
