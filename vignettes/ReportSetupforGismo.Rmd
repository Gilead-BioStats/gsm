---
title: "Report Setup for Gismo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Report Setup for Gismo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = F}
library(gsm)
```

## Overview

This vignette describes how to create new metrics, reports and shiny app modules that are compatible with `gismo`. 

## Study Configuration

Each study will select a set of metrics, reports and apps to be run as part of the Risk Assessment process. These will be documented in the Central Monitoring Plan and converted to a machine-readable study configuration yaml that looks something like this: 

```
StudyID: ABC-123
Users: Admin, User, Restricted
Reports: 
  Admin:
     - deep_dive_app
     - endpoint_pfs_bicr
  User: 
     - kri_site
     - kri_country
     - endpoints_pfs
  Restricted:
     - unblinded_kri_site
Metrics: # all available to everyone
     - kri0001
     - end0001 
     ...
```

Reports listed in the study config can then be set up via metadata provided as part of the package. 

## Module Set-up

### Overview

Each Report will be part of a qualified package and have at least one standard configuration file, but supporting files are likely necessary: 

1. `{report_name}.yaml` A workflow that specifies the steps required to produce the report. This includes the following sections:
  -  `meta`: (required) Report metadata used for centralized library and fields referenced in `steps` section of workflow.
    - This is not required in the `{report_name}.yaml` if the report is entirely comprised of `metric`s that have their own `yaml` configuration files. 
  - `spec`: (required) Data table requirement for the report. Typically from `Mapped_*` or `Reporting_*` data, but occasionally from `Analytics_*` and `Reporting_*` data sources. 
  - `steps`: (required) Functions to produce the reporting output from `Mapped_*` and/or `Reporting_*` data to final output (`html`, `csv` or `shinyApp`).
   
If the report requires the aggregation of metrics, then each metric will have a `{metric_name}.yaml` in the `metrics` directory that includes:

- `meta`: Report metadata used for centralized library and fields referenced in `steps` section of workflow.
- `spec`: Data requirement for that specific metric, typically from `Mapped_*` data, but occasionally from `Analysis_*` or `Reporting_*` data sources.
- `steps`: Function calls to create the metric output to be used in the report.

 
### Types of Data Used in Workflows

Throughout this vignette, we will reference a variety of types of data, that all have fixed prefixes to identify their source and usage. Below, the five types of data are defined.

- `Raw_*`: Raw data table from g.dash, Raw+, edc, or other validated source.
- `Mapped_*`: Mapped data table that specifies and renames the columns needed from the `Raw_*` data for a given report.
- `Temp_*`: A temporary data table that is created by a step in a workflow and not saved externally. Typically used for custom filtering of data for particular metric analytics.
- `Analysis_*`: The output data tables of the `{gsm}` analytics workflow, specified in the [Analytics Workflow Vignette](LINK)
- `Reporting_*`: The output data tables of the `{gsm}` reporting workflow, specified in the [Reporting Workflow Vignette](LINK)
   
### `meta` section content

Meta header required fields for **all** `yaml`s: 

- `Name`: Name of the reporting output.
- `File`: `yaml` file that contains the workflow.
- `ModuleID`/`MetricID`: The unique ID that is referenced in the Study Config `yaml`. 
- `Description`: A description of the reporting output specified in the workflow.
- `Repo`: Package repo and version.
- `Status`: The validation status of the reporting output. Valid values: 
    - `Qualified`: Output has been qualified via our qualification process specified [here](https://gilead-biostats.github.io/gsm/articles/QualificationWorkflow.html). 
    - `Pilot`: Output is being used by pilot studies and is maintained in a package repository.
    - `Prototype`: Output is created using custom scripts on an ad-hoc basis.
    

Additional meta header required fields **apps** and **reports**: 

- `ModuleType`: The type of reporting output specified in the workflow. Valid values: `Application`, `Report`, `Metric`.
- `Permission`: Level of permissions for viewing that match the `Users` argument in the Study Config file. Common values: `Admin`, `Users`.
- `Outputs`: The output of the workflow, including format.
- `Dependencies`: `{gsm}` ecosystem package dependencies. Specified with two elements, `Functions`, `Data`.
    - `Functions`: Names of any functions from other `{gsm}` packages that are required for this workflow. Specify with {package}::{function}.
    - `Data`: Names of any dataframes created in other `{gsm}` packages that are required for this workflow
- `ExampleURL`: Location of a sample report (typically on the pkgdown site) **Standardize this**

#### Required fields

### `spec` section content

Any needed data for the workflow to run, whether that be `Mapped_*`, `Analysis_*` or `Reporting_*`. For `Mapped_*` data, each column that is needed will be specified and contain the following information:

- `required`: Boolean field specifying whether of not this column is required for the workflow to run, or optional/recommended for inclusion for user experience or augmented information.
- `type`: Character field describing the data type of the column. Use a `mode` as defined by R.


### `steps` section content

#### Example yamls for KRI Reports

The Report yaml:
```
  File: report_example.yaml
  ModuleID: example_report
  Name: An example report
  Description: A report that is an example
  ModuleType: Report
  Repo: gsm v2.0.1
  Status: Qualified
  Permission: Users
  Outputs: An html report
  Dependencies:
    Data:
      - Reporting_Results
      - Reporting_Groups
      - Reporting_Metrics
      - Reporting_Bounds
  ExampleURL: https://gilead-biostats.github.io/gsm.example/example_report.html
spec: 
  Reporting_Results: Reporting_Results
  Reporting_Groups: Reporting_Groups
  Reporting_Metrics: Reporting_Metrics
  Reporting_Bounds: Reporting_Bounds
steps:
  - name: RunQuery
    output: Reporting_Results_Country
    params:
      df: Reporting_Results
      strQuery: "SELECT * FROM df WHERE GroupLevel == 'Country'"
  - name: RunQuery
    output: Reporting_Metrics_Country
    params:
      df: Reporting_Metrics
      strQuery: "SELECT * FROM df WHERE GroupLevel == 'Country'"
  - name: MakeCharts
    output: lCharts_Country
    params:
      dfResults: Reporting_Results_Country
      dfGroups: Reporting_Groups
      dfBounds: Reporting_Bounds
      dfMetrics: Reporting_Metrics
  - name: Report_KRI
    output: lReport 
    params:
      lCharts: lCharts_Country
      dfResults: Reporting_Results_Country
      dfGroups: Reporting_Groups
      dfMetrics: Reporting_Metrics_Country
```

A supporting metric yaml:
```
meta:
  File: kri0003.yaml
  Name: An example metric
  Description: A metric that is an example
  Repo: gsm v2.0.1
  Status: Qualified
  MetricID: kri0003
  GroupLevel: Site
  Abbreviation: PD
  Metric: Non-Important Protocol Deviation Rate
  Numerator: Non-Important Protocol Deviations
  Denominator: Days on Study
  Model: Normal Approximation
  Score: Adjusted Z-Score
  Type: rate
  Threshold: -3,-2,2,3
  nMinDenominator: 30
spec:
  Mapped_PD:
    subjid:
      required: true
  Mapped_ENROLL:
    subjid:
      required: true
    invid:
      required: true
    timeonstudy:
      required: true
steps:
  - name: ParseThreshold
    output: vThreshold
    params:
      strThreshold: Threshold
  - name: RunQuery
    output: Temp_NONIMPORTANT
    params:
      df: Mapped_PD
      strQuery: "SELECT * FROM df WHERE deemedimportant = 'No'"
  - name: Input_Rate
    output: Analysis_Input
    params:
      dfSubjects: Mapped_ENROLL
      dfNumerator: Temp_NONIMPORTANT
      dfDenominator: Mapped_ENROLL
      strSubjectCol: subjid
      strGroupCol: invid
      strGroupLevel: GroupLevel
      strNumeratorMethod: Count
      strDenominatorMethod: Sum
      strDenominatorCol: timeonstudy
  - name: Transform_Rate
    output: Analysis_Transformed
    params:
      dfInput: Analysis_Input
  - name: Analyze_NormalApprox
    output: Analysis_Analyzed
    params:
      dfTransformed: Analysis_Transformed
      strType: Type
  - name: Flag_NormalApprox
    output: Analysis_Flagged
    params:
      dfAnalyzed: Analysis_Analyzed
      vThreshold: vThreshold
  - name: Summarize
    output: Analysis_Summary
    params:
      dfFlagged: Analysis_Flagged
      nMinDenominator: nMinDenominator
```
  


## Step-by-Step
