---
title: "Cookbook"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Cookbook}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(gsm)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette contains a series of examples showing how to run analysis workflows for the Good Statistical Monitoring `{gsm}` package using sample data from [`{clindata}`](https://github.com/Gilead-BioStats/clindata). 

`{gsm}` leverages Key Risk Indicators (KRIs) and thresholds to conduct study-level and site-level Risk Based Monitoring for clinical trials.

For more information on the `{gsm}` package see the [package homepage](https://gilead-biostats.github.io/gsm/). The [Data Pipeline Vignette](https://gilead-biostats.github.io/gsm/articles/DataPipeline.html) provides additional technical details including data specifications and handling of metadata. The [Data Analysis Vignette](https://gilead-biostats.github.io/gsm/articles/DataAnalysis.html) provides detailed information about the nested functions that support the analysis workflows.

## Setup and Installation

### Install `{gsm}`, `{clindata}`, and `{safetyData}`

Run the following:

```{r eval = FALSE, include = TRUE}
## Install devtools
install.packages('devtools')

## Install and load sample raw data
devtools::install_github("Gilead-BioStats/clindata", ref = "main")
library(clindata)

## Install and load sample CDISC-compliant SDTM and ADaM data
install.packages('safetyData')
library(safetyData)

## Install and load gsm
devtools::install_github("Gilead-BioStats/gsm", ref = "main")
library(gsm)
```

To use the most recent development version from GitHub, run:

```{r eval = FALSE, include = TRUE}
devtools::install_github("Gilead-BioStats/gsm", ref = "dev")
```


## Example 1 - Running an Assessment on Standard Data


```{r eval = FALSE, include = TRUE}
dfInput <- Input_Rate(
  dfSubjects= clindata::rawplus_dm,
  dfNumerator= clindata::rawplus_ae,
  dfDenominator = clindata::rawplus_dm,
  strSubjectCol = "subjid",
  strGroupCol = "siteid",
  strNumeratorMethod= "Count",
  strDenominatorMethod= "Sum",
  strDenominatorCol= "timeonstudy"
)

dfTransformed <- Transform_Rate(dfInput)
dfAnalyzed <- Analyze_NormalApprox(dfTransformed, strType = "rate")
dfFlagged <- Flag_NormalApprox(dfAnalyzed, vThreshold = c(-3,-2,2,3))
dfSummarized <- Summarize(dfFlagged)
table(dfSummarized$Flag)

```

Can also be done with pipes, if desired 

```{r eval = FALSE, include = TRUE}
SAE_KRI <- Input_Rate(
  dfSubjects= clindata::rawplus_dm,
  dfNumerator= clindata::rawplus_ae %>% filter(aeser=="Y"),
  dfDenominator = clindata::rawplus_dm,
  strSubjectCol = "subjid",
  strGroupCol = "siteid",
  strNumeratorMethod= "Count",
  strDenominatorMethod= "Sum",
  strDenominatorCol= "timeonstudy"
) %>%
  Transform_Rate %>%
  Analyze_NormalApprox(strType = "rate") %>%
  Flag_NormalApprox(vThreshold = c(-3,-2,2,3)) %>%
  Summarize

table(SAE_KRI$Flag)

```

## Example 2 - Running a Single Assessment with Charts and Report


```{r eval = FALSE, include = TRUE}
dfInput <- Input_Rate(
  dfSubjects= clindata::rawplus_dm,
  dfNumerator= clindata::rawplus_ae,
  dfDenominator = clindata::rawplus_dm,
  strSubjectCol = "subjid",
  strGroupCol = "siteid",
  strNumeratorMethod= "Count",
  strDenominatorMethod= "Sum",
  strDenominatorCol= "timeonstudy"
)

dfTransformed <- Transform_Rate(dfInput)
dfAnalyzed <- Analyze_NormalApprox(dfTransformed,
                                   strType = "rate")
dfFlagged <- Flag_NormalApprox(dfAnalyzed,
                               vThreshold = c(-3,-2,2,3))
dfSummarized <- Summarize(dfFlagged)
dfBounds <- Analyze_NormalApprox_PredictBounds(dfTransformed = dfTransformed,
                                               vThreshold = c(-3,-2,2,3))

##create dfMetrics meta object for charts
dfMetrics <- data.frame(
  MetricID =  "kri0001",
  file = "kri0001.yaml",
  group = "site",
  abbreviation = "AE",
  metric = "Adverse Event Rate",
  numerator = "Adverse Events",
  denominator = "Days on Study",
  model = "Normal Approximation",
  score = "Adjusted Z-Score"
)

#add Study and Snapshot information to dfBounds and dfSummarized
dfBounds <- dfBounds %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date()) %>%
  mutate(MetricID = dfMetrics$MetricID)

dfSummarized <- dfSummarized %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date()) %>%
  mutate(MetricID = dfMetrics$MetricID)


# create Visualizations
lCharts <- Visualize_Metric(
  dfSummary = dfSummarized,
  dfBounds = dfBounds,
  dfSite = clindata::ctms_site %>% rename(SiteID = site_num),
  dfMetrics = dfMetrics,
  strMetricID = dfMetrics$MetricID
)

# Run reports
strOutpath <- "~/gsm_site_report_kri0001.html"
Report_KRI(lCharts = lCharts,
           dfSummary = dfSummarized,
           dfSite = dfSite,
           dfStudy = dfStudy,
           dfMetrics =dfMetrics,
           strOutpath = strOutpath)

```

# Using YAML files to run workflows 

## Example 3 - YAML workflow for multiple KRIs


```{r eval = FALSE, include = TRUE}
# Prepare Workflows
wf_mapping <- MakeWorkflowList(strNames = "mapping")[[1]]
wf_metrics <- MakeWorkflowList(strNames = "kri0001")
dfMetrics <- wf_metrics %>% map_df(function(wf){
  wf$meta$vThreshold <- paste(wf$meta$vThreshold, collapse = ",")
  return(wf$meta)
})

# Import Site+Study Metadata
dfStudy<-clindata::ctms_study %>% rename(StudyID = protocol_number)
dfSite<- clindata::ctms_site %>% rename(SiteID = site_num)

# Pull Raw Data - this will overwrite the previous data pull
lRaw <- gsm::UseClindata(
  list(
    "dfSUBJ" = "clindata::rawplus_dm",
    "dfAE" = "clindata::rawplus_ae",
    "dfPD" = "clindata::ctms_protdev",
    "dfLB" = "clindata::rawplus_lb",
    "dfSTUDCOMP" = "clindata::rawplus_studcomp",
    "dfSDRGCOMP" = "clindata::rawplus_sdrgcomp %>%
      dplyr::filter(.data$phase == 'Blinded Study Drug Completion')",
    "dfDATACHG" = "clindata::edc_data_points",
    "dfDATAENT" = "clindata::edc_data_pages",
    "dfQUERY" = "clindata::edc_queries",
    "dfENROLL" = "clindata::rawplus_enroll"
  )
)

# Create Mapped Data
lMapped <- RunWorkflow(lWorkflow = wf_mapping, lData = lRaw)$lData
# Run Metrics
lResults <-wf_metrics %>% map(~RunWorkflow(lWorkflow=.x, lData=lMapped))

table(lResults$kri0001$lData$dfSummary$Flag)
```

## Example 4 - Generate Charts with yaml workflow for multiple KRIs


```{r eval = FALSE, include = TRUE}
## Prepare Workflows
wf_mapping <- MakeWorkflowList(strNames="mapping")[[1]]
wf_metrics <- MakeWorkflowList(strNames=paste0("kri",sprintf("%04d", 1:12)))
dfMetrics <- wf_metrics %>% map_df(function(wf){
  wf$meta$vThreshold <- paste(wf$meta$vThreshold, collapse = ",")
  return(wf$meta)
})

## Import Site+Study Metadata
dfStudy<-clindata::ctms_study %>% rename(StudyID = protocol_number)
dfSite<- clindata::ctms_site %>% rename(SiteID = site_num)

## Pull Raw Data - this will overwrite the previous data pull
lRaw <- gsm::UseClindata(
  list(
    "dfSUBJ" = "clindata::rawplus_dm",
    "dfAE" = "clindata::rawplus_ae",
    "dfPD" = "clindata::ctms_protdev",
    "dfLB" = "clindata::rawplus_lb",
    "dfSTUDCOMP" = "clindata::rawplus_studcomp",
    "dfSDRGCOMP" = "clindata::rawplus_sdrgcomp %>%
      dplyr::filter(.data$phase == 'Blinded Study Drug Completion')",
    "dfDATACHG" = "clindata::edc_data_points",
    "dfDATAENT" = "clindata::edc_data_pages",
    "dfQUERY" = "clindata::edc_queries",
    "dfENROLL" = "clindata::rawplus_enroll"
  )
)

## Create Mapped Data
lMapped <- RunWorkflow(lWorkflow = wf_mapping, lData = lRaw)$lData
## Run Metrics
lResults <-wf_metrics %>% map(~RunWorkflow(lWorkflow=.x, lData=lMapped))

dfBounds <- lResults %>%
  imap_dfr(~.x$lData$dfBounds %>% mutate(MetricID = .y)) %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date())

dfSummary <- lResults %>%
  imap_dfr(~.x$lData$dfSummary %>% mutate(MetricID = .y)) %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date())

# create Visualizations
lCharts <- unique(dfSummary$MetricID) %>% map(~Visualize_Metric(
  dfSummary = dfSummary,
  dfBounds = dfBounds,
  dfSite = dfSite,
  dfMetrics = dfMetrics,
  strMetricID = .x
)
) %>% setNames(unique(dfSummary$MetricID))

#view charts
lCharts$kri0001$scatter
lCharts$kri0001$barMetricJS

```

## Example 5: Generate Site Report with yaml workflow for multiple KRIs

```{r eval = FALSE, include = TRUE}
## Prepare Workflows
wf_mapping <- MakeWorkflowList(strNames="mapping")[[1]]
wf_metrics <- MakeWorkflowList(strNames=paste0("kri",sprintf("%04d", 1:12)))
dfMetrics <- wf_metrics %>% map_df(function(wf){
  wf$meta$vThreshold <- paste(wf$meta$vThreshold, collapse = ",")
  return(wf$meta)
})

## Import Site+Study Metadata
dfStudy<-clindata::ctms_study %>% rename(StudyID = protocol_number)
dfSite<- clindata::ctms_site %>% rename(SiteID = site_num)

## Pull Raw Data - this will overwrite the previous data pull
lRaw <- gsm::UseClindata(
  list(
    "dfSUBJ" = "clindata::rawplus_dm",
    "dfAE" = "clindata::rawplus_ae",
    "dfPD" = "clindata::ctms_protdev",
    "dfLB" = "clindata::rawplus_lb",
    "dfSTUDCOMP" = "clindata::rawplus_studcomp",
    "dfSDRGCOMP" = "clindata::rawplus_sdrgcomp %>%
      dplyr::filter(.data$phase == 'Blinded Study Drug Completion')",
    "dfDATACHG" = "clindata::edc_data_points",
    "dfDATAENT" = "clindata::edc_data_pages",
    "dfQUERY" = "clindata::edc_queries",
    "dfENROLL" = "clindata::rawplus_enroll"
  )
)

## Create Mapped Data
lMapped <- RunWorkflow(lWorkflow = wf_mapping, lData = lRaw)$lData
## Run Metrics
lResults <-wf_metrics %>% map(~RunWorkflow(lWorkflow=.x, lData=lMapped))

dfBounds <- lResults %>%
  imap_dfr(~.x$lData$dfBounds %>% mutate(MetricID = .y)) %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date())

dfSummary <- lResults %>%
  imap_dfr(~.x$lData$dfSummary %>% mutate(MetricID = .y)) %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date())

# create Visualizations
lCharts <- unique(dfSummary$MetricID) %>% map(~Visualize_Metric(
  dfSummary = dfSummary,
  dfBounds = dfBounds,
  dfSite = dfSite,
  dfMetrics = dfMetrics,
  strMetricID = .x
)
) %>% setNames(unique(dfSummary$MetricID))

# Run reports
strOutpath <- "~/gsm_site_report_db.html"
Report_KRI(lCharts = lCharts,
           dfSummary = dfSummary,
           dfSite = dfSite,
           dfStudy = dfStudy,
           dfMetrics =dfMetrics,
           strOutpath = strOutpath)

```

## Example 6: Generate Country Report with yaml workflow for multiple KRIs

```{r eval = FALSE, include = TRUE}
# Prepare Workflows
wf_mapping <- MakeWorkflowList(strNames="mapping")[[1]]
wf_metrics <- MakeWorkflowList(strNames=paste0("cou",sprintf("%04d", 1:12)))
dfMetrics <- wf_metrics %>% map_df(function(wf){
  wf$meta$vThreshold <- paste(wf$meta$vThreshold, collapse = ",")
  return(wf$meta)
})

# Import Site+Study Metadata
dfStudy<-clindata::ctms_study %>% rename(StudyID = protocol_number)
dfSite<- clindata::ctms_site %>% rename(SiteID = site_num)

# Pull Raw Data - this will overwrite the previous data pull
lRaw <- gsm::UseClindata(
  list(
    "dfSUBJ" = "clindata::rawplus_dm",
    "dfAE" = "clindata::rawplus_ae",
    "dfPD" = "clindata::ctms_protdev",
    "dfLB" = "clindata::rawplus_lb",
    "dfSTUDCOMP" = "clindata::rawplus_studcomp",
    "dfSDRGCOMP" = "clindata::rawplus_sdrgcomp",
    "dfDATACHG" = "clindata::edc_data_points",
    "dfDATAENT" = "clindata::edc_data_pages",
    "dfQUERY" = "clindata::edc_queries",
    "dfENROLL" = "clindata::rawplus_enroll"
  )
)

# Create Mapped Data
lMapped <- RunWorkflow(lWorkflow = wf_mapping, lData = lRaw)$lData

# Run Metrics
lResults <-wf_metrics[1] %>% map(~RunWorkflow(lWorkflow=.x, lData=lMapped))

dfBounds <- lResults %>%
  imap_dfr(~.x$lData$dfBounds %>% mutate(MetricID = .y)) %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date())

dfSummary <- lResults %>%
  imap_dfr(~.x$lData$dfSummary %>% mutate(MetricID = .y)) %>%
  mutate(StudyID = "ABC-123") %>%
  mutate(SnapshotDate = Sys.Date())

# Create charts
lCharts <- unique(dfSummary$MetricID) %>% map(~Visualize_Metric(
  dfSummary = dfSummary,
  dfBounds = dfBounds,
  dfSite = dfSite,
  dfMetrics = dfMetrics,
  strMetricID = .x
)
) %>% setNames(unique(dfSummary$MetricID))

# Run reports
strOutpath <- "~/gsm_country_report_db.html"
Report_KRI(lCharts = lCharts,
           dfSummary = dfSummary,
           dfSite = dfSite,
           dfStudy = dfStudy,
           dfMetrics = dfMetrics,
           strOutpath = strOutpath )

```

# Appendix: Custom Mapping/YAML Specifications

As mentioned in Appendix 1 of the [Data Pipeline Vignette](https://gilead-biostats.github.io/gsm/articles/DataPipeline.html#Appendix-1-Metadata-Technical-Specifications), `Study_Assess()` triggers a workflow that uses pre-defined YAML specifications that organize all of the required metadata for a given assessment or set of assessments.

In some cases, the user might want to configure their own mappings, which can be done by providing custom YAML mappings for one or more assessments.

Let's take a look at a few examples of editing YAML files for a custom workflow below.

## Example 8 - Adding a Filtering Step

There are filter steps in the default specification for the AE Assessment, but we want to add an additional filter. Let's add a step that filters the `dfImportantPD` data frame so all values of `companycategory == "WRONG TREATMENT OR INCORRECT DOSE"`:

The default mappings for the PD Assessment are saved under KRI 0004, i.e., `kri0004.yaml`:

    meta:
      file: kri0004.yaml
      MetricID: kri0004
      group: site
      abbreviation: PD
      metric: Important Protocol Deviation Rate
      numerator: Important Protocol Deviations
      denominator: Days on Study
      model: Normal Approximation
      score: Adjusted Z-Score
    vThreshold:
      - -3
      - -2
      - 2
      - 3
    steps:
      - name: Input_Rate
        output: dfInput
        params:
          dfSubjects: dfEnrolled
          dfNumerator: dfImportantPD_wrong_trt
          dfDenominator: dfEnrolled
          strSubjectCol: subjid
          strGroupCol: siteid
          strNumeratorMethod: Count
          strDenominatorMethod: Sum
          strDenominatorCol: timeonstudy
      - name: Transform_Rate
        output: dfTransformed
        params:
         dfInput: dfInput
      - name: Analyze_NormalApprox
        output: dfAnalyzed
        params:
          dfTransformed: dfTransformed
          strType: rate
      - name: Analyze_NormalApprox_PredictBounds
        output: dfBounds
        params:
          dfTransformed: dfTransformed
          strType: rate
          vThreshold: vThreshold
      - name: Flag_NormalApprox
        output: dfFlagged
        params:
          dfAnalyzed: dfAnalyzed
          vThreshold: vThreshold
      - name: Summarize
        output: dfSummary
        params:
          dfFlagged: dfFlagged

First, we want to add an additional `RunQuery()` step to the workflow specification to select only PDs categorized as "WRONG TREATMENT OR INCORRECT DOSE". Because `dfImportantPD` needs to be filtered before it is used in `Input_Rate()`, the filter steps need to be placed first in the workflow.

Let's name the custom YAML file `kri0004_filtered.yaml`. It reads as follows:

    meta:
      file: kri0004.yaml
      MetricID: kri0004
      group: site
      abbreviation: PD
      metric: Important Protocol Deviation Rate
      numerator: Important Protocol Deviations
      denominator: Days on Study
      model: Normal Approximation
      score: Adjusted Z-Score
    vThreshold:
      - -3
      - -2
      - 2
      - 3
    steps:
     - name: RunQuery
        output: dfImportantPD_wrong_trt
        params:
          df: dfImportantPD
          strQuery: "SELECT * FROM df WHERE companycategory == 'WRONG TREATMENT OR INCORRECT DOSE'"
      - name: Input_Rate
        output: dfInput
        params:
          dfSubjects: dfEnrolled
          dfNumerator: dfImportantPD
          dfDenominator: dfEnrolled
          strSubjectCol: subjid
          strGroupCol: siteid
          strNumeratorMethod: Count
          strDenominatorMethod: Sum
          strDenominatorCol: timeonstudy
      - name: Transform_Rate
        output: dfTransformed
        params:
         dfInput: dfInput
      - name: Analyze_NormalApprox
        output: dfAnalyzed
        params:
          dfTransformed: dfTransformed
          strType: rate
      - name: Analyze_NormalApprox_PredictBounds
        output: dfBounds
        params:
          dfTransformed: dfTransformed
          strType: rate
          vThreshold: vThreshold
      - name: Flag_NormalApprox
        output: dfFlagged
        params:
          dfAnalyzed: dfAnalyzed
          vThreshold: vThreshold
      - name: Summarize
        output: dfSummary
        params:
          dfFlagged: dfFlagged

Now that this new workflow has been saved with a unique file name, we can call it with `MakeWorkflowList()` as above

```{r eval = FALSE, include = TRUE}
library(gsm)
library(clindata)
library(yaml)

## Read in workflow mapping
wf_mapping <- MakeWorkflowList(strNames = "mapping")
wfmetrics_custom <- MakeWorkflowList("kri0004_filtered")
dfMetrics <- wf_metrics %>% map_df(~.x$meta)

# Create Mapped Data
lMapped <- RunWorkflow(lWorkflow = wf_mapping, lData = lRaw)$lData

# Run Metrics
lResults <- RunWorkflow(lWorkflow=wfmetrics_custom, lData=lMapped)
```


# Appendix A: Full `mapping.yaml` file specification

The following YAML file creates all modified rawplus dataframes needed to run all default workflows specified in the `{gsm}` package. Additional `RunQuery()` steps can be added to this file for additional user-defined workflows.

    meta:
      file: mapping.yaml
      description: Data Mappings to prepare for metric calculations
    steps:
      - name: RunQuery
        output: dfEnrolled
       params:
         df: dfSUBJ
         strQuery: "SELECT subjectid as raw_subjectid, * FROM df WHERE enrollyn == 'Y'"
     - name: RunQuery
       output: dfSeriousAE
        params:
         df: dfAE
         strQuery: "SELECT * FROM df WHERE aeser = 'Y'"  
     - name: RunQuery
        output: dfNonimportantPD
        params:
          df: dfPD
          strQuery: "SELECT subjectenrollmentnumber as subjid, * FROM df WHERE deemedimportant == 'No'"
      - name: RunQuery
        output: dfImportantPD
        params:
          df: dfPD
          strQuery: "SELECT subjectenrollmentnumber as subjid, * FROM df WHERE deemedimportant == 'Yes'"
      - name: RunQuery
        output: dfAllLabs
        params:
          df: dfLB
          strQuery: "SELECT * FROM df WHERE toxgrg_nsv IN ('0', '1', '2', '3', '4')"
      - name: RunQuery
        output: dfToxLabs
        params:
          df: dfLB
          strQuery: "SELECT * FROM df WHERE toxgrg_nsv IN ('3', '4')"
      - name: RunQuery
        output: dfStudyDropouts
        params:
          df: dfSTUDCOMP
          strQuery: "SELECT * FROM df WHERE compyn IN ('N')"  
      - name: RunQuery
        output: dfTreatmentDropouts
        params:
          df: dfSDRGCOMP
          strQuery: "SELECT * FROM df WHERE sdrgyn IN ('N') AND phase = 'Blinded Study Drug Completion'"  
      - name: RunQuery
        output: dfValidQueries
        params:
          df: dfQUERY
          strQuery: "SELECT subjectname as subject_nsv, * FROM df WHERE querystatus IN ('Open', 'Answered', 'Closed')"
      - name: RunQuery
        output: dfOldValidQueries
        params:
          df: dfValidQueries
          strQuery: "SELECT * FROM df WHERE queryage > 30"  
      - name: RunQuery
        output: dfDataChanges
        params:
          df: dfDATACHG
          strQuery: "SELECT subjectname as subject_nsv, * FROM df"    
      - name: RunQuery
        output: dfQuery
        params:
          df: dfQUERY
          strQuery: "SELECT subjectname as subject_nsv, * FROM df"  
      - name: RunQuery
        output: dfDataEntry
        params:
          df: dfDATAENT
          strQuery: "SELECT subjectname as subject_nsv, * FROM df"
      - name: RunQuery
        output: dfSlowDataEntry
        params:
          df: dfDATAENT
          strQuery: "SELECT subjectname as subject_nsv, * FROM df WHERE data_entry_lag > 10"  
      - name: RunQuery
        output: dfChangedDataPoints
        params:
          df: dfDATACHG
          strQuery: "SELECT subjectname as subject_nsv, * FROM df WHERE n_changes > 0"  
      - name: RunQuery
        output: dfScreened
        params:
          df: dfENROLL
          strQuery: "SELECT * FROM df"
      - name: RunQuery
        output: dfScreenFail
        params:
          df: dfENROLL
          strQuery: "SELECT * FROM df WHERE enrollyn = 'N'" 

