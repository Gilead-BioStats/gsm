---
  title: "Step-by-Step Reporting Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Step-by-Step Reporting Workflow}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---
  
  ```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(gsm)
library(DT)
library(gt)

dt <- function(data){
  data %>%
    DT::datatable(
      extensions = 'FixedColumns',
      options = list(
        scrollX = FALSE,
        fixedColumns = TRUE
      ),
      rownames = FALSE
    )
}
```

# Introduction

This vignette walks users through the mechanics of the functions and workflows that produce all of the Reporting output within the `{gsm}` package. `{gsm}` leverages Key Risk Indicators (KRIs) and thresholds to conduct study-level, country-level and site-level Risk Based Monitoring for clinical trials.

These functions and workflows produce data frames, visualizations, metadata, and reports to be used in reporting and error checking at clinical sites. The image below illustrates the overarching context in which the reporting workflow runs, taking inputs from both the output of the analytics workflow, as well as raw study-, site-, and country-level data in the Raw/Raw+ format.

![](data-model.PNG){width="100%"}

All of the functions to create the data frames in the reporting data model will run automatically and sequentially when a user specifies the metadata and data needed for the report, and calls upon the `RunWorkflow()` function with the  `data_reporting.yaml` file. To create a report, the output of the `data_reporting.yaml` is fed into the `reports.yaml` to produce and html document with all charts and tables created in the reporting workflow.

Each of the individual functions can also be run independently outside of a specified `yaml` workflow.

For the purposes of this documentation, we will evaluate the input(s) and output(s) of each individual function for a specific KRI to show the stepwise progression of how a  `yaml` workflow is set up to handle and process reporting-level data.

------------------------------------------------------------------------
  
  ## Case Study - Step-by-Step Full Site-Level Report
  
  We will use sample CTMS data from the [`{clindata}`](https://github.com/Gilead-BioStats/clindata) package to run the Adverse Events (AE) Assessment, i.e., `AE_Assess()`, using the normal approximation method.

Additional statistical methods and supporting functions are explored in [Appendix 1](#appendix-1).

### Step 0 - Run Analytics Workflow

### Step 1 - Create Reporting model Data Frames

#### Step 1.1 - Transform CTMS data into `dfGroups` data frame

#### Step 1.2 - Create Metric Metadata

#### Step 1.3 - Stack `dfSummary` data into `dfResults`

#### Step 1.4 - Calculate Bounds for confidence intervals

### Step 2 - Create Visualizations

### Step 3 - Generate Report

## Using `yaml` Workflows to generate reports

### Option 1 - Run All Workflows Separately

### Option 2 - Run Single `snapshot` Workflow

## Reporting Data Tables
  

  ------------------------------------------------------------------------
    
    # Recap - Normal Approximation Adverse Event KRI
    
  -   `dfInput` used as original input using `Input_Rate()`
  -   `dfTransformed` created from `dfInput` using `Transform_Rate()`
  -   `dfAnalyzed` created from `dfTransformed` using `Analyze_NormalApprox()`
  -   `dfFlagged` created from `dfAnalyzed` using `Flag_NormalApprox()`
  -   `dfSummary` created from `dfFlagged` using `Summarize()`
  -   Scatter plot created from `dfTransformed` and `dfFlagged` using `Visualize_Scatter()`
  
  ------------------------------------------------------------------------
    
# Appendix 1 - Supporting Functions {#appendix-1}
    
  
### Mapping Functions
  
  -   `RunQuery()`: Run a SQL query to create new data.frames with filtering and column name specifications.
  -   `Input_Rate()`: Calculate a subject level rate from raw numerator and denominator data
  
  ### Transform Functions
  
  -   `Transform_Rate()`: Calculates cumulative rate of Event(s) of Interest per site
  -   `Transform_Count()`: Calculates cumulative number of Event(s) of Interest per site
  
### Analyze Functions
  
  -   `Analyze_NormalApprox()`: Uses funnel plot method with normal approximation to create analysis results for percentage/rate.
  -   `Analyze_Fisher()`: Uses Fisher's Exact Test to determine if there are non-random associations between a site and a given KRI
-   `Analyze_Identity()`: Used in the data pipeline between `Transform()` and `Flag()` functions to rename KRI and Score columns
-   `Analyze_Poisson()`: Uses a Poisson model to describe the distribution of events in the overall site population, i.e., determine how many times an event is likely to occur at a site over a specified treatment period

### Flag Functions

-   `Flag_NormalApprox()`: Default flagging function when `Analyze_NormalApprox()` is used for an assessment.
-   `Flag_Fisher()`: Default flagging function when `Analyze_Fisher()` is used for an assessment
-   `Flag_Poisson()`: Default flagging function when `Analyze_Poisson()` is used for an assessment
-   `Flag()`: Default flagging function when `Analyze_Identity()` is used for an assessment

### Visualization Functions

-   `Visualize_Scatter()`: Creates scatter plot of Total Exposure (in days, on log scale) vs Total Number of Event(s) of Interest (on linear scale). Each data point represents one site. Outliers are plotted in red with the site label attached. This plot is only created when statistical method is **not** defined as `identity`.
-   `Visualize_Score()`: Provides a standard visualization for Score or KRI.
-   `Visualize_Metric()`: Creates all available charts for a metric using the data provided.

### What Statistical Models Are Available For Each Assessment?

-   By default, all `yaml` workflow assessments specified in the `inst/workflows/` directory use the [normal approximation](https://gilead-biostats.github.io/gsm/articles/KRI%20Method.html#the-normal-approximation-method) method.
-   Optionally, other statistical methods include: [**Poisson**](https://gilead-biostats.github.io/gsm/articles/KRI%20Method.html#the-poisson-regression-method), [**Fisher's Exact**](https://gilead-biostats.github.io/gsm/articles/KRI%20Method.html#the-fishers-exact-method), and [**Identity**](https://gilead-biostats.github.io/gsm/articles/KRI%20Method.html#the-identity-method).
                                                                                                                                                                                       
                                                                                                                                                                                       ![](data-analysis-combined.PNG){width="100%"}
                                                                                                                                                                                       
